#!/bin/bash
# Initialize Kafka in KRaft mode for CI/CD

set -e

echo "Initializing Kafka in KRaft mode..."

# Set required environment variables for KRaft mode
export KAFKA_NODE_ID=1
export KAFKA_PROCESS_ROLES="broker,controller"
export KAFKA_CONTROLLER_QUORUM_VOTERS="1@kafka:29093"
export KAFKA_LISTENER_SECURITY_PROTOCOL_MAP="CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT"
export KAFKA_LISTENERS="PLAINTEXT://kafka:29092,CONTROLLER://kafka:29093,PLAINTEXT_HOST://0.0.0.0:9092"
export KAFKA_INTER_BROKER_LISTENER_NAME="PLAINTEXT"
export KAFKA_CONTROLLER_LISTENER_NAMES="CONTROLLER"
export KAFKA_ADVERTISED_LISTENERS="PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092"
export KAFKA_LOG_DIRS="/tmp/kraft-combined-logs"
export CLUSTER_ID="MkU3OEVBNTcwNTJENDM2Qk"
export KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
export KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS=0
export KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1
export KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
export KAFKA_AUTO_CREATE_TOPICS_ENABLE="true"
export KAFKA_METADATA_LOG_SEGMENT_MS=15000
export KAFKA_METADATA_MAX_RETENTION_MS=86400000

echo "KRaft mode environment variables set successfully"